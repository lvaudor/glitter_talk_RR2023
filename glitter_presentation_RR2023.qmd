---
title: '`glitter` makes SPARQL'
subtitle: '`glitter`, un package R pour explorer et collecter des donnÃ©es du web sÃ©mantique'
author: "Lise Vaudor, MaÃ«lle Salmon"
institute: "Rencontres R 2023, Avignon"
date: "21/06/2023"
format: 
  revealjs:
    df-print: kable
    scrollable: true
    logo: img/logo_small.png
    css:
     styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(glitter)
library(tidyverse)
library(kableExtra)
library(stringr)
 show=function(dt){
   dt %>% 
     as.data.frame() %>% 
     kable() %>% 
     kable_styling(bootstrap_options = c("hover","condensed"),
                 full_width = F,
                 position = "float_left",
                 font_size = 10)
   }
```

## Projet RECIT

![](img/RECIT.png)

Projet exploratoire, "Ã©mergent".


## Web sÃ©mantique, linked open data, web des donnÃ©es

![Â© Camille Scheffler](img/web_des_donnees_cscheffler.png){width="1500px"}

## Formalisation des Linked Open Data

![Â© Camille Scheffler](img/LOD_principes_cscheffler.png){width="1500px"} [exemple: URI correspondant Ã  Victor Hugo sur dbpedia](https://dbpedia.org/page/Victor_Hugo)


## Package glitter: objectifs

![](img/logo_glitter.png)


ğŸ¯ Promouvoir l'usage (exploration, recueil, analyse) des donnÃ©es du web sÃ©mantique pour les chercheurs et Ã©tudiants **usagers de R**, en:

-   facilitant l'**Ã©criture** des requÃªtes SPARQL
-   facilitant l'**envoi** des requÃªtes
-   facilitant le **nettoyage** des rÃ©sultats pour une analyse/valorisation ultÃ©rieure dans R

=> Ã  l'instar d'un "**Domain Specific Language**" (DSL), glitter correspond Ã  une *syntaxe* et des *fonctions* plus proches du tidyverse et base R que de SPARQL.


## Linked Open Data: difficultÃ©s d'appropriation et de collecte

<table><td>
- ğŸ‘€ ce qu'on apprÃ©hende directement: le **web documentaire** 
- ğŸ’­ difficultÃ©s liÃ©es Ã  la structure des donnÃ©es en **graphes** 
- ğŸ”® mÃ©tadonnÃ©es intÃ©grÃ©es aux donnÃ©es  
- ğŸ§ ï¸ transformation en donnÃ©es **tabulaires** pour analyse  
- â›ï¸ difficultÃ©s de collecte (SPARQL)
</td>
<td>
[](img/donnees_en_graphe.png){height="550px"}
</td></table

</td>

## Exemple d'exploration simple (de Wikidata)

<table>
Un exemple pour montrer comment fonctionne le package:

-   ğŸ¥ On souhaite rÃ©cupÃ©rer dans Wikidata les donnÃ©es relatives aux films,
-   ğŸ“ notamment le lieu de la narration (et les coordonnÃ©es associÃ©es),
-   ğŸŒ pour les placer sur une carte.

[ğŸ”—Lien](https://www.wikidata.org/wiki/Q3293881)

<td>
**Consultation** des informations relatives Ã  un **Ã©lÃ©ment Wikidata**:

![](img/Marius_et_Jeannette_WD.png){width="1400px"}

[ğŸ”—Lien](https://www.wikidata.org/wiki/Q3293881)
</td>

<td>
RequÃªte par le **Wikidata Query Service (WDQS)**

![](img/WDQS_films_query.png){width="1400px"}

[ğŸ”—Lien](https://query.wikidata.org/#SELECT%20%3Ffilm%20%3FfilmLabel%20%0AWHERE%20%0A%7B%0A%20%20%3Ffilm%20wdt%3AP31%20wd%3AQ11424.%20%0A%20%20SERVICE%20wikibase%3Alabel%20%7B%20bd%3AserviceParam%20wikibase%3Alanguage%20%22%5BAUTO_LANGUAGE%5D%2Cen%22.%20%7D%0A%7D%0ALIMIT%2010)

</td>
</table>

## Exemple de requÃªte simple

<table>
<td>

Dans R, sans glitter:

```{r bef_glitter, eval=FALSE}
query='SELECT ?film ?filmLabel WHERE {
  ?film wdt:P31 wd:Q11424.
  SERVICE wikibase:label {
    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en".
  }
}
LIMIT 10'
result=WikidataQueryServiceR::query_wikidata(query)
```

Dans R, avec glitter:

```{r glitter_no_SPARQL}
tib <- spq_init() %>% 
  spq_add("?film wdt:P31 wd:Q11424", .label="?film") %>% 
  spq_head(n=10) %>% 
  spq_perform()
```

</td><td>

<!-- Sans limite, cette requÃªte retournerait 267307 rÃ©sultats (fonctionne avec glitter, requÃªte directe sur WDQS entraÃ®nte Timeout) -->

- âœï¸ âš™ï¸ RÃ©daction et envoi de commandes R
- ğŸ Recueil du tableau de rÃ©sultats en tant qu'objet R
- ğŸ¯ ChaÃ®ne de traitement reproductible

```{r show_result_init,  echo=FALSE}
tib
```

</td></table>


## RequÃªte enrichie

```{r req1_lf}
tib <- spq_init() %>%                 # Initialise requÃªte puis
  spq_add("?film wdt:P31 wd:Q11424",  # Ajoute motif "?film est une instance de film" 
          .label="?film") %>%         # ... Ã©tiquette ?film  puis
  spq_add("?film wdt:P840 ?loc",      # Ajoute motif "?film a pour localisation narrative ?loc 
          .label="?loc") %>%          # ... Ã©tiquette ?loc puis
  spq_language("en,fr") %>%           # Affiche les Ã©tiquettes en anglais, ou Ã  dÃ©faut en franÃ§ais puis
  spq_head(n=10) %>%                  # SÃ©lectionne les 10 premiers rÃ©sultats puis
  spq_perform()                       # Envoie la requÃªte
```

```{r req1_lf_show , echo=FALSE}
tib
```

## Dimension de la requÃªte?

Combien de films ont la localisation narrative renseignÃ©e dans Wikidata:

```{r req_glob_lf}
tib <- spq_init() %>%                 # Initialise requÃªte puis
  spq_add("?film wdt:P31 wd:Q11424",  # Ajoute motif "?film est une instance de film"
          .label="?film") %>%         # ... Ã©tiquette ?film puis
  spq_add("?film wdt:P840 ?loc",      # Ajoute motif "?film a pour lieu de l'action ?loc" 
          .label="?loc") %>%          # ...Ã©tiquette ?loc puis
  spq_summarise(n_films=n()) %>%      # RÃ©sume en comptant le nombre de films puis
  spq_perform()                       # Envoie la requÃªte
```

```{r req_glob_lf_show , echo=FALSE}
tib
```

`r nrow(tib)`.

## DonnÃ©es enrichies pour produire une carte

```{r lf_2}
lf_2=spq_init() %>%                    # Initialise requÃªte puis
  spq_add("?film wdt:P31 wd:Q11424",   # Ajoute motif "?film est une instance de film"
          .label="?film") %>%          # ... Ã©tiquette ?film puis
  spq_add("?film wdt:P840 ?loc",       # Ajoute motif "?film a pour localisation narrative ?loc
          .label="?loc") %>%           # ... Ã©tiquette ?loc puis
  spq_add("?loc wdt:P625 ?coords") %>% 
  spq_add("?film wdt:P3383 ?image") %>%                      # ... si dispo, puis 
  spq_add("?film wdt:P921 ?subject",   # Ajoute motif "?film a pour sujet ?subject"
          .label="?subject", .required=FALSE) %>%   # ... si dispo, et Ã©tiquette ?subject puis
  spq_add("?film wdt:P577 ?date") %>%  # Ajoute motif "?film a Ã©tÃ© publiÃ© Ã  la date ?date puis
  spq_mutate(year=year(date)) %>%      # Ajoute variable year qui correspond Ã  l'annÃ©e de ?date puis
  spq_language("fr,en") %>%            # Etiquette quand demandÃ© de prÃ©fÃ©rence en franÃ§ais, Ã  dÃ©faut en anglais puis
  spq_perform()                        # Envoie la requÃªte
```


Cette table comprend `r nrow(lf_2)` lignes ((films avec affiche). Voici les premiÃ¨res:

```{r calc_lf_2_show, echo=FALSE}
lf_2_show <- lf_2 %>% 
   select(filmLabel, locLabel,coords, image,subjectLabel) %>% 
   unique() %>% 
   head()
```

```{r lf_2_show}
lf_2_show
```

## Carte mondiale des lieux de fiction 

```{r lf_c, echo=FALSE}
lf_c=lf_2 %>%    # ConsidÃ¨re lf_2 puis
  clean_wikidata_table() %>% # prÃ©fixe les uri
  select(film,ends_with("Label"),coords,image,year) %>%  # SÃ©lectionne ces variables (dont "....Label") puis
  group_by(film,coords,image,locLabel,filmLabel) %>%     # Groupe par ces variables puis 
  summarise(subjectLabel=paste0(unique(subjectLabel),    # RÃ©sume par groupe: le sujet (sur une seule ligne)   
                                        collapse=", "),  #  ... en sÃ©parant les Ã©lÃ©ments par ", "
            year=min(year),                              #  ... et l'annÃ©e comme minimum des annÃ©es de sortie   
            .groups="drop")                              # DÃ©groupe
```


```{r, echo=FALSE}
lf_m =lf_c %>% 
  transform_wikidata_coords("coords") %>% 
  mutate(popup=glue::glue("<h1>{filmLabel}</h1>
                           <li>Lieu: {locLabel}</li>
                           <li>AnnÃ©e de sortie: {year}</li>")) %>% 
  mutate(popup=case_when(is.na(image)~popup,
                         !is.na(image)~glue::glue("{popup}
                                                  <img src='{image}' height='200'>"))) %>% 
  mutate(popup=case_when(is.na(subjectLabel)~popup,
                         !is.na(subjectLabel)~glue::glue("{popup}
                                                         <li>ThÃ¨mes: {subjectLabel}</li>")))
```


```{r build_map_film, echo=FALSE}
library(leaflet) 
# DÃ©finition d'une Ã©chelle colorÃ©e 
# (en fonction de date de sortie) 
pal <- colorNumeric(c("red", "green", "blue"), c(1895,1950,1970,1990,2010,2023)) 
# CrÃ©ation de la carte 
map=leaflet(lf_m) %>% # dÃ©f carte 
  addTiles() %>% # ajout fond de carte
  addCircleMarkers(col=~pal(year), ~lng, ~lat,
                   popup = ~popup,
                   clusterOptions = markerClusterOptions()) 
```

```{r show_map, echo=FALSE}
map 
```

## Dimensionnement des requÃªtes

<table><td>
Temps de rÃ©ponse du serveur limitÃ© par un paramÃ¨tre de Time out: 

- Wikidata Query Service : 60s 
- client (par ex. glitter): 300s 

=> 220 000 de lignes pour **film**, genre, actor, **image** :

- Wikidata Query Service : âŒ 
- client (par ex. glitter): âœ…ï¸ 

</td><td>
![](img/taille_requete_3.png) 
</td></table>

## Combinaison de requÃªtes

```{r combi_queries}
get_genre_and_actors=function(film_id){
  result=spq_init() %>% 
      spq_set(film= film_id) %>% 
      spq_add("?film wdt:P136 ?genre",.label="?genre") %>%
      spq_add("?film wdt:P161 ?actor",.label="?actor",.required=FALSE) %>% 
      spq_perform() %>% 
      select(-film)
  return(result)
}

tib_genre_actors=lf_c %>%
  head() %>% 
  mutate(data=purrr::map(film,get_genre_and_actors)) %>% 
  unnest(cols=data) %>% 
  clean_wikidata_table()
```

```{r show_tib_genre_actors}
tib_genre_actors %>% select(filmLabel,genreLabel,actorLabel)
```

## Package glitter: vue d'ensemble

![](img/tidyverse_logo.jpeg){width="150px"} Un package qui suit quelques principes du tidyverse...

- usage du **pipe %\>%**
- fonctions Ã  **prÃ©fixe** (ici `spq_`)
- vise Ã  la **facilitÃ© d'utilisation** (dÃ©composition en Ã©tapes Ã©lÃ©mentaires)
- **Ã©valuation** tidy (rÃ©fÃ©rence directe aux noms de variables)
- **documentation** via des **vignettes** (par exemple [ici](http://perso.ens-lyon.fr/lise.vaudor/Rpackages/glitter/articles/glitter_for_Wikidata.html))

## Package glitter: fonctions principales

<table><td>
**Fonctions de base:** 

- spq_init() pour initier une requÃªte 
- spq_add() pour rajouter un motif de triplet 
- spq_perform() pour envoyer la requÃªte
[](img/dplyr_logo.jpeg){width="150px"} 

</td><td>

Fonctions notamment inspirÃ©es de dplyr (pour la **manipulation de donnÃ©es**) 

- spq_filter() 
- spq_select() 
- spq_arrange() 
- spq_mutate() 
- spq_group_by() 
- spq_summarise() 


</td></table>

## GÃ©nÃ©ralisation Ã  l'usage d'autres endpoints

![](img/logos_endpoints.png){width="1000px"} Exemple de requÃªte sur le SPARQL endpoint de dbpedia:

```{r dbpedia}
tib <- spq_init() %>%
  spq_add("?person dbo:birthPlace ?place") %>% # ?personne est nÃ©e Ã  ?place
  spq_add("?person dbo:profession ?job") %>%   # ?personne a pour profession ?job
  spq_add("?job rdfs:label ?jobLabel") %>%     # ?job a pour Ã©tiquette ?jobLabel
  spq_filter(lang(jobLabel)=="en") %>%         # Filtre pour ne garder que les Ã©tiquettes en anglais
  spq_add("?place rdfs:label 'Lyon'@en") %>%   # ?place a pour Ã©tiquette 'Lyon' (en anglais)
  spq_head(10) %>%
  spq_perform("dbpedia")                       # Envoie sur le SPARQL endpoint de DBPEDIA
```

```{r show_dbpedia,  echo=FALSE}
tib
```

## Utiliser les LOD pour recueillir et complÃ©ter des donnÃ©es

- ğŸŒ» donnÃ©es **botaniques** => associer une photo et un nom vernaculaire Ã  un nom d'espÃ¨ce en latin
- ğŸ™ï¸ lien entre **grandes villes et plaines alluviales** => rÃ©cupÃ©rer les populations des grandes villes et leurs coordonnÃ©es, associer Ã  une riviÃ¨re
- ğŸŒ **carte du monde** basÃ©e sur un shapefile avec des codes pays => rÃ©cupÃ©rer les noms de pays, le nom et les coordonnÃ©es de leur capitales
- ğŸ“œ corpus de **communiquÃ©s de presse du MinistÃ¨re de l'Ecologie** => rÃ©cupÃ©rer le nom du ministre, avec les dates de dÃ©but et de fin de son mandat.

=> FacilitÃ© d'usage pour (par exemple) la construction de **jeux de donnÃ©es pÃ©dagogiques**

## Et maintenant?

![](img/chantier.png){width="100px"} Chantier en cours!

ğŸ“£ Retours utilisateurs bienvenus

![](img/github_logo.png){width="50px"} Package installable et modifiable [ici](https://github.com/lvaudor/glitter). ![](img/capture_github.png){width="1500px"}
ğŸ§  Cas d'usages 

ğŸ™ Merci pour votre attention!
