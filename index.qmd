---
title: '`glitter` makes SPARQL'
subtitle: '`glitter`, un package R pour explorer et collecter des donnÃ©es du web sÃ©mantique'
author: "Lise Vaudor, MaÃ«lle Salmon"
institute: "Rencontres R 2023, Avignon"
date: "21/06/2023"
format: 
  revealjs:
    df-print: kable
    scrollable: true
    logo: img/logo_small.png
    css:
     styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(glitter)
library(tidyverse)
library(kableExtra)
library(stringr)
 show=function(dt){
   dt %>% 
     as.data.frame() %>% 
     kable() %>% 
     kable_styling(bootstrap_options = c("hover","condensed"),
                 full_width = F,
                 position = "float_left",
                 font_size = 10)
   }
```

## Projet RECIT

Appel Ã  projet de l'ENS de Lyon "Projets Ã©mergents" => ğŸ’° 20 000 euros sur 3 ans

![](img/RECIT.png)


## Web sÃ©mantique, linked open data, web des donnÃ©es

![Â© Camille Scheffler](img/web_des_donnees_cscheffler.png){width="1500px"}

## Formalisation des Linked Open Data

![Â© Camille Scheffler](img/LOD_principes_cscheffler.png){width="1500px"} [exemple: URI correspondant au film "Marius et Jeannette" sur Wikidata](https://www.wikidata.org/wiki/Q3293881)

## Package glitter: objectifs

![](img/logo_glitter.png)

ğŸ¯ Promouvoir l'usage (exploration, recueil, analyse) des donnÃ©es du web sÃ©mantique pour les chercheurÂ·seÂ·s et Ã©tudiantÂ·eÂ·s **usagers de R**, en:

-   facilitant l'**Ã©criture** des requÃªtes SPARQL
-   facilitant l'**envoi** des requÃªtes
-   favoriser l'analyse/valorisation ultÃ©rieure dans R

En tant que "**Domain Specific Language**" (DSL), glitter correspond Ã  une *syntaxe* et des *fonctions* plus proches du tidyverse et base R que de SPARQL.

## Linked Open Data: difficultÃ©s d'appropriation et de collecte

<table><td>
- ğŸ‘€ ce qu'on apprÃ©hende directement: le web documentaire 
- ğŸ’­ difficultÃ©s liÃ©es Ã  la structure des donnÃ©es en graphes 
- ğŸ”® mÃ©tadonnÃ©es intÃ©grÃ©es aux donnÃ©es 
- ğŸ§ ï¸ transformation en donnÃ©es tabulaires pour analyse
- â›ï¸ difficultÃ©s de collecte (SPARQL)   

</td><td>



![Du graphe de connaissances au tableau de donnÃ©es](img/donnees_en_graphe.png){width="600px"}
</td></table>

## Exemple de requÃªte simple

<table><td>

Dans R, sans glitter:

```{r bef_glitter, eval=FALSE} 
query='SELECT ?film ?filmLabel 
   WHERE { 
   ?film wdt:P31 wd:Q11424. 
   SERVICE wikibase:label{
      bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en".}
   } 
   LIMIT 10' 
result=WikidataQueryServiceR::query_wikidata(query) 
```

Dans R, avec glitter: 

```{r glitter_no_SPARQL} 
tib <- spq_init() %>% 
spq_add("?film wdt:P31 wd:Q11424", .label="?film") %>%
spq_head(n=10) %>%
spq_perform()
```
</td><td>

- ğŸ–Šï¸ RÃ©daction et envoi de commandes R
- ğŸ Recueil du tableau de rÃ©sultats en tant qu'objet R 
- ğŸ¯ ChaÃ®ne de traitement reproductible 

```{r show_result_init, echo=FALSE}
tib
```

</td></table>

## Dimension de la requÃªte?

Combien de films dans Wikidata:

```{r req_glob_lf}
tib <- spq_init() %>%                 # Initialise requÃªte puis
  spq_add("?film wdt:P31 wd:Q11424",  # Ajoute motif "?film est une instance de film"
          .label="?film") %>%         # ... Ã©tiquette ?film puis
  spq_summarise(n_films=n()) %>%      # RÃ©sume en comptant le nombre de films puis
  spq_perform()                       # Envoie la requÃªte
```

```{r req_glob_lf_show , echo=FALSE}
tib
```

## DonnÃ©es enrichies pour produire une carte

```{r lf_2}
lf_2=spq_init() %>%                     # Initialise requÃªte puis
  spq_add("?film wdt:P31 wd:Q11424",    # Ajoute motif "?film est une instance de film"
          .label="?film") %>%           # ... Ã©tiquette ?film puis
  spq_add("?film wdt:P840 ?loc",        # Ajoute motif "?film a pour localisation narrative ?loc
          .label="?loc") %>%            # ... Ã©tiquette ?loc puis
  spq_add("?loc wdt:P625 ?coords") %>%  # Ajoute les coordonnÃ©es de ?loc puis
  spq_add("?film wdt:P3383 ?image") %>% # Ajoute l'affiche du film 
  spq_add("?film wdt:P921 ?subject",    # Ajoute ?subject
          .label="?subject",            # et l'Ã©tiquette associÃ©e
          .required=FALSE) %>%          # si dispo
  spq_add("?film wdt:P577 ?date") %>%   # Ajoute ?date (la date de sortie) puis
  spq_mutate(year=year(date)) %>%       # Ajoute variable year qui correspond Ã  l'annÃ©e de ?date puis
  spq_select(-date) %>%                 # Retire date des variables renvoyÃ©es 
  spq_language("fr,en") %>%             # Etiquette quand demandÃ© de prÃ©fÃ©rence en franÃ§ais, Ã  dÃ©faut en anglais puis
  spq_perform()                         # Envoie la requÃªte
```

Cette table comprend `r nrow(lf_2)` lignes (films avec localisation narrative, coordonnÃ©es associÃ©es et affiche). Voici les premiÃ¨res:

```{r calc_lf_2_show, echo=FALSE}
lf_2_show <- lf_2 %>% 
   select(filmLabel, locLabel,coords, image,subjectLabel, year) %>% 
   unique() %>% 
   head()
```

```{r lf_2_show}
lf_2_show
```

## Carte mondiale des lieux de fiction

```{r lf_c, echo=FALSE}
lf_c=lf_2 %>%    # ConsidÃ¨re lf_2 puis
  clean_wikidata_table() %>% # prÃ©fixe les uri
  select(film,ends_with("Label"),coords,image,year) %>%  # SÃ©lectionne ces variables (dont "....Label") puis
  group_by(film,coords,image,locLabel,filmLabel) %>%     # Groupe par ces variables puis 
  summarise(subjectLabel=paste0(unique(subjectLabel),    # RÃ©sume par groupe: le sujet (sur une seule ligne)   
                                        collapse=", "),  #  ... en sÃ©parant les Ã©lÃ©ments par ", "
            year=min(year),                              #  ... et l'annÃ©e comme minimum des annÃ©es de sortie   
            .groups="drop")                              # DÃ©groupe
```

```{r, echo=FALSE}
lf_m =lf_c %>% 
  transform_wikidata_coords("coords") %>% 
  mutate(popup=glue::glue("<h1>{filmLabel}</h1>
                           <li>Lieu: {locLabel}</li>
                           <li>AnnÃ©e de sortie: {year}</li>")) %>% 
  mutate(popup=case_when(is.na(image)~popup,
                         !is.na(image)~glue::glue("{popup}
                                                  <img src='{image}' height='200'>"))) %>% 
  mutate(popup=case_when(is.na(subjectLabel)~popup,
                         !is.na(subjectLabel)~glue::glue("{popup}
                                                         <li>ThÃ¨mes: {subjectLabel}</li>")))
```

```{r build_map_film, echo=FALSE}
library(leaflet) 
# DÃ©finition d'une Ã©chelle colorÃ©e 
# (en fonction de date de sortie) 
pal <- colorNumeric(c("red", "green", "blue"), c(1895,1950,1970,1990,2010,2023)) 
# CrÃ©ation de la carte 
map=leaflet(lf_m) %>% # dÃ©f carte 
  addTiles() %>% # ajout fond de carte
  addCircleMarkers(col=~pal(year), ~lng, ~lat,
                   popup = ~popup,
                   clusterOptions = markerClusterOptions()) 
```

```{r show_map, echo=FALSE}
map 
```

## Package glitter: vue d'ensemble

![](img/tidyverse_logo.jpeg){width="50px"} Un package qui suit quelques principes du tidyverse...

-   usage du **pipe %>%**
-   fonctions Ã  **prÃ©fixe** (ici `spq_`)
-   vise Ã  la **facilitÃ© d'utilisation** (dÃ©composition en Ã©tapes Ã©lÃ©mentaires)
-   **Ã©valuation** tidy (rÃ©fÃ©rence directe aux noms de variables)
-   attention accordÃ©e Ã  la **documentation** (par exemple via des **vignettes**) 

## Package glitter: fonctions principales

<table><td> 
Fonctions de base:

- spq_init() pour initier une requÃªte 
- spq_add() pour rajouter un motif de triplet 
- spq_perform() pour envoyer la requÃªte 
</td><td>

![](img/dplyr_logo.jpeg){width="50px"} Fonctions inspirÃ©es de dplyr :

- spq_filter() 
- spq_select() 
- spq_arrange() 
- spq_mutate() 
- spq_group_by() 
- spq_summarise() 

=> "Where the magic is" (MaÃ«lle)

</td></table>

## GÃ©nÃ©ralisation Ã  l'usage d'autres endpoints

![](img/logos_endpoints.png){width="1000px"} Exemple de requÃªte sur le SPARQL endpoint de dbpedia:

```{r dbpedia}
tib <- spq_init() %>%
  spq_add("?person dbo:birthPlace ?place") %>% # ?personne est nÃ©e Ã  ?place
  spq_add("?person dbo:profession ?job") %>%   # ?personne a pour profession ?job
  spq_add("?job rdfs:label ?jobLabel") %>%     # ?job a pour Ã©tiquette ?jobLabel
  spq_filter(lang(jobLabel)=="en") %>%         # Filtre pour ne garder que les Ã©tiquettes en anglais
  spq_add("?place rdfs:label 'Lyon'@en") %>%   # ?place a pour Ã©tiquette 'Lyon' (en anglais)
  spq_head(10) %>%
  spq_perform("dbpedia")                       # Envoie sur le SPARQL endpoint de DBPEDIA
```

```{r show_dbpedia,  echo=FALSE}
tib
```

## Utiliser les LOD pour recueillir et complÃ©ter des donnÃ©es

Exemples pratiques d'utilisation:

-   ğŸŒ» donnÃ©es **botaniques** => associer une photo et un nom vernaculaire Ã  un nom d'espÃ¨ce en latin
-   ğŸ“œ corpus de **communiquÃ©s de presse du MinistÃ¨re de l'Ecologie** => rÃ©cupÃ©rer le nom du ministre, avec les dates de dÃ©but et de fin de son mandat.
-   ğŸ™ï¸ lien entre **grandes villes et plaines alluviales** => rÃ©cupÃ©rer les populations des grandes villes et leurs coordonnÃ©es, associer Ã  une riviÃ¨re
-   ğŸŒ **carte du monde** basÃ©e sur un shapefile avec des codes pays => rÃ©cupÃ©rer les noms de pays, le nom et les coordonnÃ©es de leur capitales

=> Richesse thÃ©matique pour (par exemple) la construction de **jeux de donnÃ©es pÃ©dagogiques**

## Et maintenant?

![](img/chantier.png){width="100px"} Chantier en cours!

ğŸ“£ Retours utilisateurs bienvenus

![](img/github_logo.png){width="25px"} Package installable et modifiable ici [https://github.com/lvaudor/glitter](https://github.com/lvaudor/glitter).

ğŸ§  Cas d'usages: Ã  vous de jouer!

ğŸ™ Merci pour votre attention!

